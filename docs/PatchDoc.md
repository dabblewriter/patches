<!-- Placeholder for PatchDoc documentation -->

# `PatchDoc<T>`

The `PatchDoc<T>` class is the client-side representation of a collaborative document managed by the Patches OT system. It encapsulates the local state, manages synchronization with the server, and handles the client-side operational transformation logic.

**Table of Contents**

- [Overview](#overview)
- [Initialization](#initialization)
- [State Management](#state-management)
  - [Committed State](#committed-state)
  - [Optimistic State](#optimistic-state)
  - [Pending Changes](#pending-changes)
  - [Sending Changes](#sending-changes)
- [Making Local Changes](#making-local-changes)
  - [`update()`](#update)
- [Synchronization with Server](#synchronization-with-server)
  - [`getUpdatesForServer()`](#getupdatesforserver)
  - [`applyServerConfirmation()`](#applyserverconfirmation)
  - [`applyExternalServerUpdate()`](#applyexternalserverupdate)
- [Accessing State and Metadata](#accessing-state-and-metadata)
  - [`state` (Getter)](#state-getter)
  - [`committedRev` (Getter)](#committedrev-getter)
  - [`isSending` (Getter)](#issending-getter)
  - [`hasPending` (Getter)](#haspending-getter)
  - [`export()`](#export)
  - [`import()`](#import)
  - [`setChangeMetadata()`](#setchangemetadata)
- [Event Emitters](#event-emitters)
  - [`onUpdate`](#onupdate)
  - [`onChange`](#onchange)
  - [`onBeforeChange`](#onbeforechange)
- [Example Usage](#example-usage)

## Overview

`PatchDoc` acts as the client's local model for a document being edited collaboratively. Its primary responsibilities are:

1.  **Maintaining State:** It keeps track of the last known server-confirmed state (`committedState`), any changes currently being sent to the server (`sendingChanges`), and any local changes not yet sent (`pendingChanges`). It computes the current _optimistic_ state (`state`) by layering these changes.
2.  **Applying Local Edits:** Provides an `update` method (similar to Immer) to modify the local state. This generates JSON Patch operations and applies them optimistically.
3.  **Client-Side OT:** Implements the necessary logic to send changes, receive confirmations, receive external changes, and rebase local changes accordingly.

## Initialization

You create a `PatchDoc` instance, typically after fetching the initial document state and its corresponding revision number from your server.

```typescript
import { PatchDoc } from 'patches-ot';

interface MyDocument {
  title: string;
  content: { /* ... */ };
  counter: number;
}

// Assume these are fetched from the server
const initialDocId = 'doc-abc';
const initialServerState: MyDocument = /* ... fetched state ... */;
const initialServerRev: number = /* ... fetched revision ... */;

// Optional: Metadata to associate with changes from this client
const clientMetadata = { userId: 'user-123', sessionId: 'session-xyz' };

const doc = new PatchDoc<MyDocument>(initialServerState, initialServerRev, clientMetadata);

console.log(doc.state); // Initially equals initialServerState
console.log(doc.committedRev); // Initially equals initialServerRev
```

- See [Initialization in PatchServer docs](./PatchServer.md#initialization) for server setup.

* **`initialState`**: The starting state of the document.
* **`initialMetadata`** (Optional): An object containing key-value pairs to be included in the `metadata` field of `Change` objects generated by this `PatchDoc` instance.

## State Management

`PatchDoc` manages several internal states to handle optimistic updates and synchronization:

### Committed State

- Stored internally as `_committedState`.
- Represents the last document state that has been acknowledged (committed) by the server.
- This state is only updated when receiving confirmations (`applyServerConfirmation`) or external updates (`applyExternalServerUpdate`) from the server.
- The revision number corresponding to this state is stored in `_committedRev` (accessible via the `committedRev` getter).

### Optimistic State

- Accessible via the `state` getter.
- This is the state displayed to the user in the UI.
- It is calculated by applying the `_sendingChanges` and then the `_pendingChanges` on top of the `_committedState`.
- This provides immediate feedback to the user for their local actions.

### Pending Changes

- Stored internally as `_pendingChanges` (an array of `Change` objects).
- These are changes generated locally via the `update()` method that have _not yet_ been sent to the server.
- The `hasPending` getter returns `true` if this array is not empty.

### Sending Changes

- Stored internally as `_sendingChanges` (an array of `Change` objects).
- These are changes that have been retrieved using `getUpdatesForServer()` and are currently in flight to the server, awaiting confirmation.
- The `isSending` getter returns `true` if this array is not empty.
- `PatchDoc` generally expects only one batch of changes to be in the `sending` state at a time to simplify state management.

## Making Local Changes

### `update()`

This is the primary method for modifying the document state locally.

```typescript
doc.update(draft => {
  draft.title = 'New Document Title';
});
```

- Uses Immer-like principles (proxies provided by [`createPatchProxy`](./json-patch.md#createpatchproxy-utility)) to track changes.
- Generates [`JSONPatchOp`](../src/types.ts) operations.
- Queues a [`Change`](./types.ts) object for sending.

## Synchronization with Server

These methods manage the communication flow with the central [`PatchServer`](./PatchServer.md).

### `getUpdatesForServer()`

Call this method to retrieve the changes that need to be sent to the server.

- Moves pending changes to the sending queue.
- Ensures `baseRev` is set correctly based on [`committedRev`](#committedrev-getter).

### `applyServerConfirmation()`

Call this method after receiving the server's response (usually a single [`Change`](./types.ts) object or `[]`) to a batch sent via `getUpdatesForServer()`.

- Applies the confirmed change to the committed state.
- Updates `committedRev`.
- **Rebases** pending changes using [`rebaseChanges()`](./utils.ts).

### `applyExternalServerUpdate()`

Call this method when receiving changes from the server that originated from _other_ clients (broadcast by the [`PatchServer`](./PatchServer.md)).

- Applies external changes to the committed state.
- Updates `committedRev`.
- **Rebases** both sending and pending changes using [`rebaseChanges()`](./utils.ts).

## Accessing State and Metadata

### `state` (Getter)

Returns the current optimistic local state ( `_committedState` + `_sendingChanges` + `_pendingChanges`). This is the state you should typically render in the UI.

```typescript
const currentState = doc.state;
// Render UI based on currentState
```

### `committedRev` (Getter)

Returns the revision number (`_committedRev`) of the last state acknowledged by the server.

```typescript
const revision = doc.committedRev;
```

### `isSending` (Getter)

Returns `true` if there is a batch of changes currently awaiting confirmation from the server (`_sendingChanges` is not empty).

```typescript
if (doc.isSending) {
  // Maybe show a "Saving..." indicator
}
```

### `hasPending` (Getter)

Returns `true` if there are local changes that have not yet been sent to the server (`_pendingChanges` is not empty).

```typescript
if (doc.hasPending) {
  // Maybe enable a "Send Changes" button
}
```

### `export()`

Exports the _committed_ state and revision. **Does not include pending or sending changes.** Useful for basic persistence, but be aware that importing this state will discard any unconfirmed local work.

```typescript
const snapshot = doc.export();
// { state: /* committed state */, rev: /* committed revision */ }
// Save snapshot to localStorage, etc.
```

### `import()`

Resets the `PatchDoc` to a specific committed state and revision, discarding _all_ pending and sending changes. Use this to synchronize a client to a known server state, for example, after a forced resync.

```typescript
// Assume `snapshot` was previously exported or received from server
doc.import(snapshot);
// Now doc.state === snapshot.state and doc.committedRev === snapshot.rev
// All local unconfirmed changes are gone.
```

### `setChangeMetadata()`

Allows you to set or update the metadata object that will be included with subsequent `Change` objects generated by `doc.update()`.

```typescript
doc.setChangeMetadata({ userId: 'user-456', theme: 'dark' });

doc.update(draft => {
  draft.title = 'Metadata Test';
});
// The resulting Change object in _pendingChanges will have:
// metadata: { userId: 'user-456', theme: 'dark' }
```

## Event Emitters

`PatchDoc` provides signals (using `easy-signal`) to subscribe to various events.

### `onUpdate`

Triggered whenever the optimistic `state` getter might have changed. This happens after:

- A local `update()` successfully applies changes.
- `applyServerConfirmation()` processes a server response.
- `applyExternalServerUpdate()` processes changes from other clients.
- `import()` loads a new state.

```typescript
const unsubscribe = doc.onUpdate((newState, theDocInstance) => {
  console.log('Optimistic state updated:', newState);
  // Update UI
});

// Later...
unsubscribe();
```

### `onChange`

Triggered immediately _after_ a local change generated by `update()` has been applied optimistically and added to the pending queue.

```typescript
doc.onChange((localChange, theDocInstance) => {
  console.log('Local change applied optimistically:', localChange);
});
```

### `onBeforeChange`

Triggered immediately _before_ a local change generated by `update()` is applied optimistically.

```typescript
doc.onBeforeChange((changeAboutToBeApplied, theDocInstance) => {
  console.log('About to apply local change:', changeAboutToBeApplied);
});
```

## Example Usage

See the [Simple Client Setup example in the main README.md](../README.md#simple-client-setup).
Also see related server example: [Simple Server Setup example in the main README.md](../README.md#simple-server-setup).
